{% extends 'game_1/base.html' %}

{% block title %} waiting_typing_room {% endblock %}

{% block content %}
    <section class="waiting-typing vh-100">
        <div class="container pt-1 pb-1 h-100">
            <div class="d-flex flex-column justify-content-center align-items-between h-100">

                <div class="waiting-header">
                    <h1 class="p-2 d-flex justify-content-center bg-primary text-white rounded-pill" style="font-weight: bold; font-size: 26px">Ждем игроков раунда №{{ round }}</h1>
                </div>

                {# ОПОВЕЩЕНИЯ ДЖАНГИ #}
                {% include '../blocks/django_messages.html' %}

                <div class="waiting-typing-players text-center">
                    <h2>Игроки которые уже ответили</h2>
                    <div class="row">
                        {% for p in players %}
                            <div class="col-3 p-auto pb-2">
                                <div class="bg-success text-center text-white fw-bold">
                                    <div class="pt-2">{{ p.player.player_in_room }}</div>
                                    <div class="pb-2 pt-2">done</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="waiting-typing-done d-flex flex-column pt-2 pb-2">
                    <a href="{% url 'result_room' slug %}" class="answer_link btn btn-primary alredy_done__link" >Показать ответы</a>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block user_scripts %}
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

    {#  шаблоны html страницы для пользователей в комнате #}
    {% verbatim %}
    <script id="playersThereTmpl" type="text/x-jquery-tmpl">
            <div class="base-info">
                {{each data_players.users}}
                    <div class="bg-success text-center text-white fw-bold">
                        <div class="pt-2">${username}</div>
                        <div class="pb-2 pt-2">done</div>
                    </div>
                {{/each}}
            </div>
        </div>
    </script>
    {% endverbatim %}

    <script type="text/javascript">

        function add_players_there(data_players) {
            // добавить игроков в шаблон

            $('#waitingPlayersThere').empty()
            $('#playersThereTmpl').tmpl(data_players).appendTo('#waitingPlayersThere');
        };


        function redirect_to_typing_room(gameroom){
            // проверит начата ил игра и перенаправит всех пользователей на typing rom
            // косытьль - нужно делать пост запрос с параметром юзера, и если его игра началась то редиректить его

            if (gameroom.status_game === true){
                $(location).attr('href',"{% url 'typing_room' slug %}");
            }
        }

        function get_players_ajax() {
            // получить список игроков и вставить их в шаблон

            $.ajax({
                url: "{% url 'waiting_room_api_gatusers' slug %}",
                type: 'get',
                dataType: 'json',
                cache: false,
                success: function (data) {
                    add_players_there(data_players=data)
                    console.log(data.gameroom)
                    {#redirect_to_typing_room(data.gameroom)#}
                },
                failure: function (data) {
                    alert('Got an error dude');
                }
            })
        }

        // получение списка игроков при заходе на страницу
        $(function() {get_players_ajax()})

        // обновить список игроков каждые 5 секунд
        setInterval(function() {
            get_players_ajax()
        }, 5000);

        // обновить список при клике на кнопку
        $(".waiting-players-there-btn").click(function(){
            get_players_ajax()
        });


    </script>
{% endblock %}